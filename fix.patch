 (cd "$(git rev-parse --show-toplevel)" && git apply --3way <<'EOF' 
diff --git a/.gitignore b/.gitignore
index e2700de9940662ad25e825bce60ed26128c77321..dad90f52cc158e350fbb6e903476d6a7a470383d 100644
--- a/.gitignore
+++ b/.gitignore
@@ -1,37 +1,40 @@
 # --- Python bytecode & cache ---
 __pycache__/
 *.py[cod]
 *.pyo
 *.pyd
 *.sqlite3
 
 # --- Virtual environments ---
 # Ignore all .env files (but NOT .env.example)
 .env
 .env.*
 !.env.example
+# Allow committed docker env templates for services
+!backend/services/user_management/.env.docker
+!backend/services/decision_engine_fastapi/.env.docker
 venv/
 *.env
 
 # --- Jupyter checkpoints ---
 .ipynb_checkpoints/
 
 # --- Node / frontend ---
 node_modules/
 frontend/webapp/.next/
 frontend/webapp/.turbo/
 frontend/webapp/.vercel/
 npm-debug.log*
 yarn-debug.log*
 yarn-error.log*
 pnpm-debug.log*
 
 # --- VS Code / IDE ---
 .vscode/
 *.code-workspace
 
 # --- OS junk ---
 .DS_Store
 Thumbs.db
 
 # --- Docker local overrides & logs ---
diff --git a/backend/services/decision_engine_fastapi/.env.docker b/backend/services/decision_engine_fastapi/.env.docker
new file mode 100644
index 0000000000000000000000000000000000000000..1f2d38e7d2d16e2f0264f28511dfba515d18ffc1
--- /dev/null
+++ b/backend/services/decision_engine_fastapi/.env.docker
@@ -0,0 +1,5 @@
+# FastAPI configuration for talking to Django in docker-compose
+DJANGO_API_BASE_URL=http://django:8000/api/v1
+DJANGO_TOKEN_URL=http://django:8000/api/v1/auth/token/
+DJANGO_AUTH_USERNAME=fastapi_service
+DJANGO_AUTH_PASSWORD=fastapi_service_password
diff --git a/backend/services/user_management/.env.docker b/backend/services/user_management/.env.docker
new file mode 100644
index 0000000000000000000000000000000000000000..c83a55f4bd4f167e49751d17894bc267fbfb6e83
--- /dev/null
+++ b/backend/services/user_management/.env.docker
@@ -0,0 +1,14 @@
+# Django service configuration for docker-compose
+USE_POSTGRES=true
+POSTGRES_DB=smartfarm
+POSTGRES_USER=smartfarm
+POSTGRES_PASSWORD=smartfarm_password
+POSTGRES_HOST=db
+POSTGRES_PORT=5432
+
+DJANGO_SECRET_KEY=dev-secret-key-change-me
+DJANGO_DEBUG=true
+
+# Service account for FastAPI
+DJANGO_AUTH_USERNAME=fastapi_service
+DJANGO_AUTH_PASSWORD=fastapi_service_password
diff --git a/backend/services/user_management/api/management/commands/ensure_service_user.py b/backend/services/user_management/api/management/commands/ensure_service_user.py
index c8063786e4adcd7f57d41f5b8e0e2f89da9a81cd..d667ec5cb507eadf01f66f595790ba2866621394 100644
--- a/backend/services/user_management/api/management/commands/ensure_service_user.py
+++ b/backend/services/user_management/api/management/commands/ensure_service_user.py
@@ -1,31 +1,31 @@
-from django.core.management.base import BaseCommand
+from django.core.management.base import BaseCommand, CommandError
 from django.contrib.auth import get_user_model
 import os
 
 User = get_user_model()
 
+
 class Command(BaseCommand):
     help = "Create or update the inter-service API user (for FastAPI â†’ Django)."
 
     def handle(self, *args, **kwargs):
         username = os.getenv("DJANGO_AUTH_USERNAME")
         password = os.getenv("DJANGO_AUTH_PASSWORD")
 
         if not username or not password:
-            self.stderr.write(
-                "DJANGO_AUTH_USERNAME and DJANGO_AUTH_PASSWORD must be set"
+            raise CommandError(
+                "DJANGO_AUTH_USERNAME and DJANGO_AUTH_PASSWORD must be set to create the service user."
             )
-            return
 
         user, created = User.objects.update_or_create(
             username=username,
             defaults={"is_staff": True, "is_superuser": True},
         )
 
         user.set_password(password)
         user.save()
 
         if created:
             self.stdout.write(f"Created new service user: {username}")
         else:
             self.stdout.write(f"Updated existing service user: {username}")
diff --git a/docker-compose.yml b/docker-compose.yml
index 9c25bdb9cdd3686e91bfca84bfc72446a729bbf4..72e47d8ab50c241e07a4e2ebe81f10c0add3eb14 100644
--- a/docker-compose.yml
+++ b/docker-compose.yml
@@ -1,62 +1,82 @@
 version: "3.9"
 
 services:
 
   db:
     image: postgres:15
     container_name: smartfarm_db
     restart: unless-stopped
     environment:
-      POSTGRES_DB: ${POSTGRES_DB}
-      POSTGRES_USER: ${POSTGRES_USER}
-      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
+      POSTGRES_DB: ${POSTGRES_DB:-smartfarm}
+      POSTGRES_USER: ${POSTGRES_USER:-smartfarm}
+      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-smartfarm_password}
     volumes:
       - postgres_data:/var/lib/postgresql/data
     ports:
       - "5432:5432"
     networks:
       - smartnet
 
   django:
     build:
       context: ./backend/services/user_management
       dockerfile: Dockerfile
     container_name: smartfarm_django
     restart: unless-stopped
     env_file:
-      - ./backend/services/user_management/.env
+      - ./backend/services/user_management/.env.docker
     depends_on:
       - db
     ports:
       - "8000:8000"
     networks:
       - smartnet
     command: >
       sh -c "
-        python manage.py migrate &&
-        python manage.py ensure_service_user &&
+        python - <<'PY' && \
+        python manage.py migrate --noinput && \
+        python manage.py ensure_service_user && \
         python manage.py runserver 0.0.0.0:8000
+        import os
+        import time
+        import psycopg2
+
+        while True:
+            try:
+                conn = psycopg2.connect(
+                    dbname=os.getenv('POSTGRES_DB'),
+                    user=os.getenv('POSTGRES_USER'),
+                    password=os.getenv('POSTGRES_PASSWORD'),
+                    host=os.getenv('POSTGRES_HOST', 'db'),
+                    port=os.getenv('POSTGRES_PORT', '5432'),
+                )
+                conn.close()
+                break
+            except Exception as exc:
+                print(f"Waiting for database: {exc}")
+                time.sleep(2)
+        PY
       "
 
   fastapi:
     build:
       context: ./backend/services/decision_engine_fastapi
       dockerfile: Dockerfile
     container_name: smartfarm_fastapi
     restart: unless-stopped
     env_file:
-      - ./backend/services/decision_engine_fastapi/.env
+      - ./backend/services/decision_engine_fastapi/.env.docker
     depends_on:
       - django
     ports:
       - "9000:9000"
     networks:
       - smartnet
     command: >
       uvicorn app.main:app --host 0.0.0.0 --port 9000 --reload
 
 volumes:
   postgres_data:
 
 networks:
   smartnet:
 
EOF
)