# NOTE:
# - `version` حذف شده (Docker Compose v2 نیازی ندارد)
# - build.context برای همه سرویس‌ها ریشه پروژه است (../../)
# - Dockerfile هر سرویس صراحتاً مشخص شده

networks:
  sfs_net:

volumes:
  postgres_data:

services:

  postgres:
    image: postgres:15
    container_name: sfs-postgres
    restart: always
    env_file:
      - ../env/postgres.env
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - sfs_net

  management:
    container_name: sfs-management
    command: >
      sh -c "
        python -m django collectstatic --noinput &&
        gunicorn config.wsgi:application --bind 0.0.0.0:8000 --workers 2 --timeout 60
      "
    restart: always
    build:
      context: ../../
      dockerfile: infrastructure/docker/management/Dockerfile
    env_file:
      - ../env/management.env
    depends_on:
      - postgres
    ports:
      - "8000:8000"
    networks:
      - sfs_net

  monitoring:
    container_name: sfs-monitoring
    restart: always
    build:
      context: ../../
      dockerfile: infrastructure/docker/monitoring/Dockerfile
    env_file:
      - ../env/monitoring.env
    ports:
      - "8002:8002"
    networks:
      - sfs_net

  data_ingestion:
    container_name: sfs-data-ingestion
    restart: always
    build:
      context: ../../
      dockerfile: infrastructure/docker/data_ingestion/Dockerfile
    env_file:
      - ../env/data_ingestion.env
    depends_on:
      - management
      - monitoring
    ports:
      - "8001:8001"
    networks:
      - sfs_net

  edge_controller:
    container_name: sfs-edge-controller
    restart: always
    build:
      context: ../../
      dockerfile: infrastructure/docker/edge_controller/Dockerfile
    env_file:
      - ../env/edge_controller.env
    depends_on:
      - data_ingestion
    ports:
      - "8003:8003"
    networks:
      - sfs_net

  ai_decision:
    container_name: sfs-ai-decision
    restart: always
    build:
      context: ../../
      dockerfile: infrastructure/docker/ai_decision/Dockerfile
    env_file:
      - ../env/ai_decision.env
    depends_on:
      - management
    ports:
      - "8004:8004"
    networks:
      - sfs_net

  webapp:
    container_name: sfs-webapp
    restart: always
    build:
      context: ../../frontend/webapp
      dockerfile: ../../infrastructure/docker/webapp/Dockerfile
    env_file:
      - ../env/webapp.env
    ports:
      - "3000:3000"
    depends_on:
      - management
      - monitoring
      - ai_decision
    networks:
      - sfs_net
