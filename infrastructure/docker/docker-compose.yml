networks:
  sfs_net:

volumes:
  postgres_data:

services:
  # --- Base image (single source of truth) ---
  base:
    image: sfs_base:latest
    build:
      context: ../..
      dockerfile: infrastructure/docker/Dockerfile.base
    networks:
      - sfs_net

  postgres:
    image: postgres:15
    container_name: sfs-postgres
    restart: always
    environment:
      POSTGRES_DB: sfs
      POSTGRES_USER: sfs
      POSTGRES_PASSWORD: sfs
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - sfs_net

  management:
    container_name: sfs-management
    restart: always
    build:
      context: ../..
      dockerfile: infrastructure/docker/management/Dockerfile
    depends_on:
      - base
      - postgres
    environment:
      # اگر env_file داری، می‌تونی این‌ها رو ببری آنجا
      DJANGO_SETTINGS_MODULE: config.settings.dev
      DATABASE_URL: postgres://sfs:sfs@postgres:5432/sfs
      PYTHONPATH: /app/backend:/app/backend/services
    ports:
      - "8000:8000"
    networks:
      - sfs_net

  data_ingestion:
    container_name: sfs-data-ingestion
    restart: always
    build:
      context: ../..
      dockerfile: infrastructure/docker/data_ingestion/Dockerfile
    depends_on:
      - base
      - postgres
    environment:
      PYTHONPATH: /app/backend:/app/backend/services
    ports:
      - "8001:8001"
    networks:
      - sfs_net

  monitoring:
    container_name: sfs-monitoring
    restart: always
    build:
      context: ../..
      dockerfile: infrastructure/docker/monitoring/Dockerfile
    depends_on:
      - base
      - postgres
    environment:
      PYTHONPATH: /app/backend:/app/backend/services
    ports:
      - "8002:8002"
    networks:
      - sfs_net

  edge_controller:
    container_name: sfs-edge-controller
    restart: always
    build:
      context: ../..
      dockerfile: infrastructure/docker/edge_controller/Dockerfile
    depends_on:
      - base
      - postgres
    environment:
      PYTHONPATH: /app/backend:/app/backend/services
    ports:
      - "8003:8003"
    networks:
      - sfs_net

  ai_decision:
    container_name: sfs-ai-decision
    restart: always
    build:
      context: ../..
      dockerfile: infrastructure/docker/ai_decision/Dockerfile
    depends_on:
      - base
      - postgres
    environment:
      PYTHONPATH: /app/backend:/app/backend/services
    ports:
      - "8004:8004"
    networks:
      - sfs_net

  webapp:
    container_name: sfs-webapp
    restart: always
    build:
      context: ../..
      dockerfile: infrastructure/docker/webapp/Dockerfile
    depends_on:
      - management
      - monitoring
      - ai_decision
    ports:
      - "3000:3000"
    networks:
      - sfs_net
